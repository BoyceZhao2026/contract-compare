import{d as ce,r as g,a as he,c as ye,w as we,b,e as o,f as h,g as k,h as D,i as s,j as e,u as p,k as se,l as d,t as P,v as ae,s as ie,m as ne,F as re,E as v,n as fe,o as q,p as u,_ as ge,q as Fe,x as Ce,y as de,z as ke,A as be,B as Ve,C as $e,D as De,G as Pe,H as xe,I as ee,J as le,K as ze,L as Re,M as Se,N as te,O as ue,P as Ue,Q as Le}from"./index-BaIfRFaL.js";const Me={key:0,class:"upload-step"},Be={class:"comparison-form"},Ne={key:0,class:"file-info"},Te={key:0,class:"file-info"},Ee={key:1,class:"content-selection-step"},Ye={class:"selection-container"},Ie={class:"selection-header"},qe={class:"selection-panels"},He={class:"selection-panel"},je={class:"panel-header"},Oe={class:"panel-actions"},Ke={class:"panel-content"},We={class:"selection-panel"},Ae={class:"panel-header"},Ge={class:"panel-actions"},Je={class:"panel-content"},Qe={class:"dialog-footer"},Xe=ce({__name:"NewComparisonDialog",props:{modelValue:{type:Boolean}},emits:["update:modelValue","created"],setup(oe,{emit:Y}){const H=fe(),j=oe,O=Y,F=g(),U=g(),L=g(),i=he({originalFile:null,targetFile:null,originalPath:"",targetPath:""}),w=g("upload"),x=g(!1),S=g(!1),C=g(""),m=g(""),V=ye({get:()=>j.modelValue,set:n=>O("update:modelValue",n)}),$={original:[{required:!0,message:"请选择原文件",trigger:"change",validator:(n,l,a)=>{i.originalFile?a():a(new Error("请选择原文件"))}}],target:[{required:!0,message:"请选择目标文件",trigger:"change",validator:(n,l,a)=>{i.targetFile?a():a(new Error("请选择目标文件"))}}]},G=(n,l)=>{const a=n.raw;if(!a.name.toLowerCase().endsWith(".docx")&&!a.name.toLowerCase().endsWith(".doc")){v.error("只能上传 .docx 或 .doc 文件"),l==="original"?(U.value?.clearFiles(),i.originalFile=null):(L.value?.clearFiles(),i.targetFile=null),F.value?.validateField(l);return}if(a.size>50*1024*1024){v.error("文件大小不能超过 50MB"),l==="original"?(U.value?.clearFiles(),i.originalFile=null):(L.value?.clearFiles(),i.targetFile=null),F.value?.validateField(l);return}l==="original"?(i.originalFile=a,console.log("原文件已选择:",a.name)):(i.targetFile=a,console.log("目标文件已选择:",a.name)),F.value?.validateField(l),console.log("当前表单状态:",{originalFile:i.originalFile?.name,targetFile:i.targetFile?.name})},K=n=>{n==="original"?(i.originalFile=null,i.originalPath=""):(i.targetFile=null,i.targetPath=""),F.value?.validateField(n)},I=async n=>{const l=new FormData;l.append("file",n);try{const a=await q.post("/contract/upload",l,{headers:{"Content-Type":"multipart/form-data"}});if(a.data.code===200)return a.data.data.path;throw new Error(a.data.message||"文件上传失败")}catch(a){throw console.error("文件上传失败:",a),a}},X=async(n,l)=>{try{const a={batchId:null,originalFilename:i.originalFile?.name,targetFilename:i.targetFile?.name,originalFilePath:n,targetFilePath:l},t=await q.post("/contract/record",a);if(t.data.code!==200)throw new Error(t.data.message||"记录保存失败")}catch(a){throw console.error("记录比对失败:",a),a}},M=async()=>{if(F.value){console.log("开始上传文件，表单状态:",{originalFile:i.originalFile?.name,targetFile:i.targetFile?.name});try{if(await F.value.validate(),console.log("表单验证通过"),x.value=!0,i.originalFile===i.targetFile){v.error("原文件和目标文件不能相同");return}const n=await I(i.originalFile);i.originalPath=n;const l=await I(i.targetFile);i.targetPath=l,console.log("文件上传完成，进入内容选择步骤"),w.value="select"}catch(n){console.error("上传失败:",n),v.error(n.message||"操作失败，请重试")}finally{x.value=!1}}},Z=async()=>{try{S.value=!0,console.log("开始比对，内容选择状态:",{originalSelected:C.value?`${C.value.substring(0,50)}...`:"全文",targetSelected:m.value?`${m.value.substring(0,50)}...`:"全文"}),await X(i.originalPath,i.targetPath);const n={original:i.originalPath,target:i.targetPath};C.value&&(n.originalContent=encodeURIComponent(C.value)),m.value&&(n.targetContent=encodeURIComponent(m.value)),W(),O("created"),await H.push({name:"compare",query:n})}catch(n){console.error("开始比对失败:",n),v.error(n.message||"操作失败，请重试")}finally{S.value=!1}},T=(n,l)=>{n==="original"?C.value=l:m.value=l},E=n=>{v.info("请在下方面板中选择内容")},J=n=>{n==="original"?C.value="":m.value=""},W=()=>{if(w.value==="select"&&x.value){w.value="upload";return}V.value=!1,Q()},Q=()=>{F.value?.resetFields(),i.originalFile=null,i.targetFile=null,i.originalPath="",i.targetPath="",U.value?.clearFiles(),L.value?.clearFiles(),w.value="upload",C.value="",m.value="",x.value=!1,S.value=!1};return we(V,n=>{n||Q()}),(n,l)=>{const a=h("el-icon"),t=h("el-upload"),r=h("el-text"),_=h("el-form-item"),z=h("el-form"),R=h("el-alert"),y=h("el-button"),A=h("el-dialog");return u(),b(A,{modelValue:V.value,"onUpdate:modelValue":l[10]||(l[10]=f=>V.value=f),title:w.value==="upload"?"新建合同比对":"选择比对内容",width:w.value==="upload"?"600px":"90%","before-close":W,class:"comparison-dialog"},{footer:o(()=>[s("div",Qe,[e(y,{onClick:W},{default:o(()=>[d(P(w.value==="upload"?"取消":"返回上传"),1)]),_:1}),w.value==="upload"?(u(),b(y,{key:0,type:"primary",onClick:M,loading:x.value,disabled:!i.originalFile||!i.targetFile},{default:o(()=>[...l[19]||(l[19]=[d(" 选择内容 ",-1)])]),_:1},8,["loading","disabled"])):D("",!0),w.value==="select"?(u(),b(y,{key:1,type:"primary",onClick:Z,loading:S.value},{default:o(()=>[...l[20]||(l[20]=[d(" 开始比对 ",-1)])]),_:1},8,["loading"])):D("",!0)])]),default:o(()=>[w.value==="upload"?(u(),k("div",Me,[s("div",Be,[e(z,{model:i,rules:$,ref_key:"formRef",ref:F,"label-width":"100px"},{default:o(()=>[e(_,{label:"原文件",prop:"original"},{default:o(()=>[e(t,{ref_key:"originalUpload",ref:U,class:"upload-demo",drag:"","auto-upload":!1,"on-change":f=>G(f,"original"),"on-remove":()=>K("original"),limit:1,accept:".docx,.doc"},{tip:o(()=>[...l[11]||(l[11]=[s("div",{class:"el-upload__tip"}," 只能上传 .docx 或 .doc 文件，且不超过 50MB ",-1)])]),default:o(()=>[e(a,{class:"el-icon--upload"},{default:o(()=>[e(p(se))]),_:1}),l[12]||(l[12]=s("div",{class:"el-upload__text"},[d(" 将文件拖到此处，或"),s("em",null,"点击上传")],-1))]),_:1},8,["on-change","on-remove"]),i.originalFile?(u(),k("div",Ne,[e(r,{type:"success",size:"small"},{default:o(()=>[d(" 已选择: "+P(i.originalFile.name),1)]),_:1})])):D("",!0)]),_:1}),e(_,{label:"目标文件",prop:"target"},{default:o(()=>[e(t,{ref_key:"targetUpload",ref:L,class:"upload-demo",drag:"","auto-upload":!1,"on-change":f=>G(f,"target"),"on-remove":()=>K("target"),limit:1,accept:".docx,.doc"},{tip:o(()=>[...l[13]||(l[13]=[s("div",{class:"el-upload__tip"}," 只能上传 .docx 或 .doc 文件，且不超过 50MB ",-1)])]),default:o(()=>[e(a,{class:"el-icon--upload"},{default:o(()=>[e(p(se))]),_:1}),l[14]||(l[14]=s("div",{class:"el-upload__text"},[d(" 将文件拖到此处，或"),s("em",null,"点击上传")],-1))]),_:1},8,["on-change","on-remove"]),i.targetFile?(u(),k("div",Te,[e(r,{type:"success",size:"small"},{default:o(()=>[d(" 已选择: "+P(i.targetFile.name),1)]),_:1})])):D("",!0)]),_:1})]),_:1},8,["model"])])])):D("",!0),w.value==="select"?(u(),k("div",Ee,[s("div",Ye,[s("div",Ie,[e(R,{title:"选择要对比的内容",description:"可以选择文档的全部内容或部分内容进行对比。如果不选择，将对比整个文档。",type:"info",closable:!1,"show-icon":""})]),s("div",qe,[s("div",He,[s("div",je,[s("h3",null,P(i.originalFile?.name)+" (基准文件)",1),s("div",Oe,[C.value?(u(),b(y,{key:0,type:"success",size:"small",plain:"",onClick:l[0]||(l[0]=f=>E("original"))},{default:o(()=>[e(a,null,{default:o(()=>[e(p(ae))]),_:1}),d(" 已选择内容 ("+P(C.value.length)+"字符) ",1)]),_:1})):(u(),b(y,{key:1,type:"primary",size:"small",plain:"",onClick:l[1]||(l[1]=f=>E("original"))},{default:o(()=>[e(a,null,{default:o(()=>[e(p(ie))]),_:1}),l[15]||(l[15]=d(" 选择内容 ",-1))]),_:1})),C.value?(u(),b(y,{key:2,type:"info",size:"small",plain:"",onClick:l[2]||(l[2]=f=>J("original"))},{default:o(()=>[e(a,null,{default:o(()=>[e(p(ne))]),_:1}),l[16]||(l[16]=d(" 清除选择 ",-1))]),_:1})):D("",!0)])]),s("div",Ke,[e(re,{"file-path":i.originalPath,"model-value":C.value,"onUpdate:modelValue":l[3]||(l[3]=f=>T("original",f)),onTextSelected:l[4]||(l[4]=f=>T("original",f))},null,8,["file-path","model-value"])])]),s("div",We,[s("div",Ae,[s("h3",null,P(i.targetFile?.name)+" (目标文件)",1),s("div",Ge,[m.value?(u(),b(y,{key:0,type:"success",size:"small",plain:"",onClick:l[5]||(l[5]=f=>E("target"))},{default:o(()=>[e(a,null,{default:o(()=>[e(p(ae))]),_:1}),d(" 已选择内容 ("+P(m.value.length)+"字符) ",1)]),_:1})):(u(),b(y,{key:1,type:"primary",size:"small",plain:"",onClick:l[6]||(l[6]=f=>E("target"))},{default:o(()=>[e(a,null,{default:o(()=>[e(p(ie))]),_:1}),l[17]||(l[17]=d(" 选择内容 ",-1))]),_:1})),m.value?(u(),b(y,{key:2,type:"info",size:"small",plain:"",onClick:l[7]||(l[7]=f=>J("target"))},{default:o(()=>[e(a,null,{default:o(()=>[e(p(ne))]),_:1}),l[18]||(l[18]=d(" 清除选择 ",-1))]),_:1})):D("",!0)])]),s("div",Je,[e(re,{"file-path":i.targetPath,"model-value":m.value,"onUpdate:modelValue":l[8]||(l[8]=f=>T("target",f)),onTextSelected:l[9]||(l[9]=f=>T("target",f))},null,8,["file-path","model-value"])])])])])])):D("",!0)]),_:1},8,["modelValue","title","width"])}}}),Ze=ge(Xe,[["__scopeId","data-v-fe72f32c"]]),el={class:"history-page"},ll={class:"page-header"},tl={class:"header-content"},al={class:"header-info"},ol={class:"page-title"},sl={class:"header-actions"},il={class:"search-section"},nl={class:"search-container"},rl={class:"search-form"},dl={class:"search-item"},ul={class:"search-item"},cl={class:"search-actions"},fl={class:"history-section"},gl={class:"card-header"},vl={class:"header-tools"},pl={class:"history-list"},ml=["onClick"],_l={class:"item-header"},hl={class:"item-time"},yl={class:"item-content"},wl={class:"file-group"},Fl={class:"file-label"},Cl={class:"file-list-with-download"},kl={class:"file-tags"},bl={class:"file-group"},Vl={class:"file-label"},$l={class:"file-list-with-download"},Dl={class:"file-tags"},Pl={class:"item-actions"},xl={key:0,class:"pagination-wrapper"},zl={key:0,class:"detail-header"},Rl={key:1,class:"diff-result"},Sl={class:"diff-controls"},Ul={key:2,class:"loading-container"},Ll=ce({__name:"HistoryView",setup(oe){fe();const Y=g(!1),H=g(!1),j=g([]),O=g(0),F=g(1),U=g(10),L=g(!1),i=g(!1),w=g(null),x=g([]),S=g(null),C=g(!1),m=g(""),V=g(""),$=g({filename:"",dateRange:[]}),G=()=>{M()},K=async(a,t)=>{try{const r=await q.get(`/contract/history/${a.batch_id}`);if(r.data.code!==200||r.data.data.length===0){v.error("获取文件信息失败");return}const _=r.data.data[0];let z,R;if(t==="original"?(z=_.originalFilePath,R=_.originalFilename):(z=_.targetFilePath,R=_.targetFilename),!z){v.error(`${t==="original"?"原":"目标"}文件路径不存在`);return}const y=await q.get("/contract/file/stream",{params:{path:z},responseType:"blob"}),A=new Blob([y.data]),f=window.URL.createObjectURL(A),B=document.createElement("a");B.href=f,B.download=R||"document.docx",document.body.appendChild(B),B.click(),window.URL.revokeObjectURL(f),document.body.removeChild(B),v.success("文件下载成功")}catch(r){console.error("文件下载失败:",r),v.error("文件下载失败")}},I=()=>{F.value=1,M()},X=()=>{$.value={filename:"",dateRange:[]},F.value=1,M()},M=async()=>{Y.value=!0;try{const a={page:F.value,size:U.value};$.value.filename&&(a.filename=$.value.filename),$.value.dateRange&&$.value.dateRange.length===2&&(a.startDate=$.value.dateRange[0],a.endDate=$.value.dateRange[1]);const t=await q.get("/contract/history",{params:a});t.data.code===200?(j.value=t.data.data.records,O.value=t.data.data.total):v.error(t.data.message||"获取历史记录失败")}catch(a){console.error("获取历史记录失败:",a),v.error("获取历史记录失败")}finally{Y.value=!1}},Z=async a=>{H.value=!0;try{const t=await q.get(`/contract/history/${a}`);if(t.data.code===200)if(x.value=t.data.data,console.log("获取到的比对详情数据:",x.value),x.value.length>0){const r=x.value[0];console.log("第一条记录详情:",r),console.log("文件路径检查:",{originalFilePath:r?.originalFilePath,targetFilePath:r?.targetFilePath,originalFilename:r?.originalFilename,targetFilename:r?.targetFilename});const _=r?.originalFilePath,z=r?.targetFilePath;if(r&&_&&z){m.value=_,V.value=z,console.log("设置文件路径成功:",{original:m.value,target:V.value}),await Le(),C.value=!0;let R=0;const y=()=>{R++,S.value?(console.log("DiffViewer组件已加载，开始比对"),n()):R<20?(console.log(`等待DiffViewer组件加载... (${R}/20)`),setTimeout(y,100)):(console.error("DiffViewer组件加载超时"),v.error("比对组件加载失败，请重试"))};setTimeout(y,100)}else console.error("文件路径信息不完整:",r),v.error(`文件路径信息不完整，请检查比对记录。原始文件路径: ${_||"空"}, 目标文件路径: ${z||"空"}`)}else v.error("没有找到比对记录");else v.error(t.data.message||"获取详情失败")}catch(t){console.error("获取详情失败:",t),v.error("获取详情失败")}finally{H.value=!1}},T=async a=>{w.value=a,i.value=!0,await Z(a.batch_id)},E=a=>new Date(a).toLocaleString("zh-CN"),J=a=>{U.value=a,F.value=1,M()},W=a=>{F.value=a,M()},Q=()=>{L.value=!1,M()},n=async()=>{if(!S.value){console.error("DiffViewer 组件未加载"),v.error("比对组件未加载，请重试");return}if(!m.value||!V.value){console.error("文件路径为空:",{original:m.value,target:V.value}),v.error("文件路径为空，请重试");return}try{if(console.log("开始历史比对:",{original:m.value,target:V.value}),typeof S.value.startDiff!="function"){console.error("DiffViewer没有startDiff方法"),v.error("比对组件方法缺失，请重试");return}await S.value.startDiff(),console.log("历史比对完成")}catch(a){console.error("历史比对失败:",a),v.error("比对失败: "+a.message)}},l=()=>{i.value=!1,C.value=!1,w.value=null,x.value=[],m.value="",V.value=""};return Fe(()=>{M()}),(a,t)=>{const r=h("el-icon"),_=h("el-button"),z=h("el-input"),R=h("el-date-picker"),y=h("el-tag"),A=h("el-pagination"),f=h("el-card"),B=h("el-descriptions-item"),ve=h("el-descriptions"),pe=h("el-skeleton"),me=h("el-dialog"),_e=xe("loading");return u(),k("div",el,[s("div",ll,[s("div",tl,[s("div",al,[s("h1",ol,[e(r,null,{default:o(()=>[e(p(de))]),_:1}),t[7]||(t[7]=d(" 合同比对历史 ",-1))]),t[8]||(t[8]=s("p",{class:"page-subtitle"},"查看和管理所有合同比对记录",-1))]),s("div",sl,[e(_,{type:"primary",size:"large",onClick:t[0]||(t[0]=c=>L.value=!0),class:"new-compare-btn"},{default:o(()=>[e(r,null,{default:o(()=>[e(p(ke))]),_:1}),t[9]||(t[9]=d(" 新建比对 ",-1))]),_:1})])])]),s("div",il,[s("div",nl,[s("div",rl,[s("div",dl,[t[10]||(t[10]=s("label",{class:"search-label"},"文件名称搜索：",-1)),e(z,{modelValue:$.value.filename,"onUpdate:modelValue":t[1]||(t[1]=c=>$.value.filename=c),placeholder:"请输入文件名称",clearable:"",style:{width:"200px"},onKeyup:Ce(I,["enter"])},null,8,["modelValue"])]),s("div",ul,[t[11]||(t[11]=s("label",{class:"search-label"},"比对日期范围：",-1)),e(R,{modelValue:$.value.dateRange,"onUpdate:modelValue":t[2]||(t[2]=c=>$.value.dateRange=c),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"240px"},onChange:I},null,8,["modelValue"])]),s("div",cl,[e(_,{type:"primary",onClick:I},{default:o(()=>[e(r,null,{default:o(()=>[e(p(be))]),_:1}),t[12]||(t[12]=d(" 搜索 ",-1))]),_:1}),e(_,{onClick:X},{default:o(()=>[e(r,null,{default:o(()=>[e(p(Ve))]),_:1}),t[13]||(t[13]=d(" 重置 ",-1))]),_:1})])])])]),s("div",fl,[e(f,{class:"history-card"},{default:o(()=>[s("div",gl,[s("h3",null,[e(r,null,{default:o(()=>[e(p(De))]),_:1}),t[14]||(t[14]=d(" 比对记录 ",-1))]),s("div",vl,[e(_,{onClick:G,loading:Y.value},{default:o(()=>[e(r,null,{default:o(()=>[e(p(Pe))]),_:1}),t[15]||(t[15]=d(" 刷新 ",-1))]),_:1},8,["loading"])])]),$e((u(),k("div",pl,[(u(!0),k(ee,null,le(j.value,c=>(u(),k("div",{key:c.batch_id,class:"history-item",onClick:N=>T(c)},[s("div",_l,[s("div",hl,[e(r,null,{default:o(()=>[e(p(de))]),_:1}),d(" "+P(E(c.create_time)),1)])]),s("div",yl,[s("div",wl,[s("div",Fl,[e(r,null,{default:o(()=>[e(p(Se))]),_:1}),t[16]||(t[16]=d(" 原文件 ",-1))]),s("div",Cl,[s("div",kl,[(u(!0),k(ee,null,le(c.original_filenames?c.original_filenames.split(","):[],N=>(u(),b(y,{key:N,type:"info",size:"small",class:"file-tag"},{default:o(()=>[d(P(N),1)]),_:2},1024))),128))]),c.original_filenames?(u(),b(_,{key:0,type:"text",size:"small",onClick:te(N=>K(c,"original"),["stop"]),class:"download-btn",title:"下载原文件"},{default:o(()=>[e(r,null,{default:o(()=>[e(p(ue))]),_:1})]),_:1},8,["onClick"])):D("",!0)])]),t[18]||(t[18]=s("div",{class:"vs-divider"},"VS",-1)),s("div",bl,[s("div",Vl,[e(r,null,{default:o(()=>[e(p(Ue))]),_:1}),t[17]||(t[17]=d(" 目标文件 ",-1))]),s("div",$l,[s("div",Dl,[(u(!0),k(ee,null,le(c.target_filenames?c.target_filenames.split(","):[],N=>(u(),b(y,{key:N,type:"success",size:"small",class:"file-tag"},{default:o(()=>[d(P(N),1)]),_:2},1024))),128))]),c.target_filenames?(u(),b(_,{key:0,type:"text",size:"small",onClick:te(N=>K(c,"target"),["stop"]),class:"download-btn",title:"下载目标文件"},{default:o(()=>[e(r,null,{default:o(()=>[e(p(ue))]),_:1})]),_:1},8,["onClick"])):D("",!0)])])]),s("div",Pl,[e(_,{type:"text",onClick:te(N=>T(c),["stop"])},{default:o(()=>[e(r,null,{default:o(()=>[e(p(ae))]),_:1}),t[19]||(t[19]=d(" 查看详情 ",-1))]),_:1},8,["onClick"])])],8,ml))),128))])),[[_e,Y.value]]),j.value.length>0?(u(),k("div",xl,[e(A,{"current-page":F.value,"onUpdate:currentPage":t[3]||(t[3]=c=>F.value=c),"page-size":U.value,"onUpdate:pageSize":t[4]||(t[4]=c=>U.value=c),"page-sizes":[10,20,50,100],total:O.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:J,onCurrentChange:W},null,8,["current-page","page-size","total"])])):D("",!0)]),_:1})]),e(Ze,{modelValue:L.value,"onUpdate:modelValue":t[5]||(t[5]=c=>L.value=c),onCreated:Q},null,8,["modelValue"]),e(me,{modelValue:i.value,"onUpdate:modelValue":t[6]||(t[6]=c=>i.value=c),title:"比对详情",width:"95%","before-close":l,class:"detail-dialog",top:"2vh"},{default:o(()=>[w.value?(u(),k("div",zl,[e(ve,{column:3,border:"",size:"small"},{default:o(()=>[e(B,{label:"批次ID"},{default:o(()=>[e(y,{type:"primary"},{default:o(()=>[d(P(w.value.batch_id),1)]),_:1})]),_:1}),e(B,{label:"比对时间"},{default:o(()=>[d(P(E(w.value.create_time)),1)]),_:1}),e(B,{label:"文件数量"},{default:o(()=>[d(P(x.value.length),1)]),_:1})]),_:1})])):D("",!0),C.value?(u(),k("div",Rl,[s("div",Sl,[e(_,{onClick:l},{default:o(()=>[e(r,null,{default:o(()=>[e(p(ze))]),_:1}),t[20]||(t[20]=d(" 关闭 ",-1))]),_:1})]),(u(),b(Re,{key:`diff-${m.value}-${V.value}`,ref_key:"diffViewerRef",ref:S,"left-path":m.value,"right-path":V.value},null,8,["left-path","right-path"]))])):H.value?(u(),k("div",Ul,[e(pe,{rows:10,animated:""}),t[21]||(t[21]=s("div",{class:"loading-text"},"正在加载比对结果...",-1))])):D("",!0)]),_:1},8,["modelValue"])])}}}),Bl=ge(Ll,[["__scopeId","data-v-0d5bee6b"]]);export{Bl as default};
